name: Build PETSc+MUMPS Bundle

on:
  workflow_dispatch:
    inputs:
      petsc_version:
        description: 'PETSc version to build'
        required: false
        default: '3.22.3'
        type: string

jobs:
  build:
    name: Build PETSc ${{ inputs.petsc_version }} with MUMPS
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: write  # Required to create releases

    env:
      PETSC_VERSION: ${{ inputs.petsc_version }}
      RELEASE_TAG: petsc-v${{ inputs.petsc_version }}-ubuntu-latest

    steps:
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libopenmpi-dev gfortran make git

      - name: Build PETSc with MUMPS
        run: |
          cd $RUNNER_TEMP
          echo "Cloning PETSc v${PETSC_VERSION}..."
          git clone --depth 1 --branch v${PETSC_VERSION} https://gitlab.com/petsc/petsc.git petsc-src
          cd petsc-src

          echo "Configuring PETSc with MUMPS..."
          ./configure \
            --prefix=$RUNNER_TEMP/petsc-${PETSC_VERSION} \
            --with-cc=mpicc --with-cxx=mpicxx --with-fc=mpif90 \
            --with-debugging=0 \
            --download-fblaslapack=1 \
            --download-metis=1 \
            --download-parmetis=1 \
            --download-scalapack=1 \
            --download-ptscotch=1 \
            --download-mumps=1 \
            --with-hdf5=0 \
            --with-curl=0 \
            --with-x=0 \
            --with-shared-libraries=1

          echo "Building PETSc (this will take ~10 minutes)..."
          make all -j$(nproc)

          echo "Installing PETSc to prefix..."
          make install

          echo "Build complete!"

      - name: Verify PETSc installation
        run: |
          echo "Checking for libpetsc.so..."
          test -f $RUNNER_TEMP/petsc-${PETSC_VERSION}/lib/libpetsc.so || {
            echo "ERROR: libpetsc.so not found!"
            exit 1
          }

          echo "Listing installed libraries:"
          ls -lh $RUNNER_TEMP/petsc-${PETSC_VERSION}/lib/*.so | head -20

          echo "Checking for MUMPS in PETSc..."
          if ldd $RUNNER_TEMP/petsc-${PETSC_VERSION}/lib/libpetsc.so | grep -i mumps; then
            echo "âœ“ MUMPS found in PETSc"
          else
            echo "âš  MUMPS not found in ldd output (may be statically linked)"
          fi

          echo "Installation verified!"

      - name: Create tarball
        run: |
          cd $RUNNER_TEMP
          echo "Creating tarball..."
          tar -czf petsc-${PETSC_VERSION}-ubuntu-latest.tar.gz petsc-${PETSC_VERSION}

          echo "Tarball info:"
          ls -lh petsc-${PETSC_VERSION}-ubuntu-latest.tar.gz

          echo "Tarball contents (top-level):"
          tar -tzf petsc-${PETSC_VERSION}-ubuntu-latest.tar.gz | head -20

      - name: Upload PETSc tarball as artifact
        uses: actions/upload-artifact@v4
        with:
          name: petsc-${{ env.PETSC_VERSION }}-ubuntu-latest
          path: ${{ runner.temp }}/petsc-${{ env.PETSC_VERSION }}-ubuntu-latest.tar.gz
          retention-days: 90

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          cd $RUNNER_TEMP

          # Delete existing release/tag if it exists
          if gh release view ${{ env.RELEASE_TAG }} --repo ${{ github.repository }} 2>/dev/null; then
            echo "Release ${{ env.RELEASE_TAG }} already exists, deleting..."
            gh release delete ${{ env.RELEASE_TAG }} --repo ${{ github.repository }} --yes
          fi

          # Create release notes
          cat > release_notes.md <<EOF
          # PETSc ${{ env.PETSC_VERSION }} with MUMPS

          Pre-built PETSc binary for Ubuntu (compatible with GitHub Actions ubuntu-latest runners).

          ## Build Configuration
          - **Version:** PETSc ${{ env.PETSC_VERSION }}
          - **Platform:** Ubuntu 22.04 (ubuntu-latest)
          - **Architecture:** x86_64
          - **Direct Solver:** MUMPS (included)
          - **MPI:** OpenMPI
          - **Build Type:** Optimized (--with-debugging=0)

          ## Features
          - âœ… MUMPS direct solver
          - âœ… METIS, ParMETIS partitioning
          - âœ… ScaLAPACK, PT-SCOTCH
          - âœ… Bundled BLAS/LAPACK
          - âŒ No HDF5 (avoids libcurl conflicts with Julia)
          - âŒ No curl dependencies

          ## Usage in GitHub Actions
          \`\`\`yaml
          - name: Download PETSc
            run: |
              wget https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/petsc-${{ env.PETSC_VERSION }}-ubuntu-latest.tar.gz
              tar -xzf petsc-${{ env.PETSC_VERSION }}-ubuntu-latest.tar.gz -C \$RUNNER_TEMP

          - name: Set JULIA_PETSC_LIBRARY
            run: echo "JULIA_PETSC_LIBRARY=\$RUNNER_TEMP/petsc-${{ env.PETSC_VERSION }}/lib/libpetsc.so" >> \$GITHUB_ENV
          \`\`\`

          ## File Details
          - **Tarball:** petsc-${{ env.PETSC_VERSION }}-ubuntu-latest.tar.gz
          - **Size:** $(ls -lh petsc-${{ env.PETSC_VERSION }}-ubuntu-latest.tar.gz | awk '{print $5}')
          - **Built:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

          # Create release
          echo "Creating release ${{ env.RELEASE_TAG }}..."
          gh release create ${{ env.RELEASE_TAG }} \
            --repo ${{ github.repository }} \
            --title "PETSc ${{ env.PETSC_VERSION }} + MUMPS (Ubuntu)" \
            --notes-file release_notes.md \
            petsc-${{ env.PETSC_VERSION }}-ubuntu-latest.tar.gz

          echo "âœ… Release created successfully!"
          echo "URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}"

      - name: Build summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully built PETSc ${PETSC_VERSION} with MUMPS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ GitHub Release (Permanent)" >> $GITHUB_STEP_SUMMARY
          echo "- **Release:** [${{ env.RELEASE_TAG }}](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Download URL:** \`https://github.com/${{ github.repository }}/releases/download/${{ env.RELEASE_TAG }}/petsc-${PETSC_VERSION}-ubuntu-latest.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** \`petsc-${PETSC_VERSION}-ubuntu-latest.tar.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Size:** $(ls -lh $RUNNER_TEMP/petsc-${PETSC_VERSION}-ubuntu-latest.tar.gz | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
          echo "- **MUMPS:** âœ… Enabled" >> $GITHUB_STEP_SUMMARY
          echo "- **HDF5/curl:** âŒ Disabled (avoids Julia conflicts)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build type:** Optimized" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Check the [release page](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ env.RELEASE_TAG }}) - it's permanent!" >> $GITHUB_STEP_SUMMARY
          echo "2. Update your CI.yml to download from this release" >> $GITHUB_STEP_SUMMARY
          echo "3. Enjoy blazing-fast CI runs! âš¡" >> $GITHUB_STEP_SUMMARY
